Continuing the GalaPo project. Build backend API for the listing detail page.

TECH: Next.js 16 Route Handlers, Supabase, TypeScript

REQUIREMENTS:

1. /app/api/listings/[slug]/route.ts:
   - GET: Fetch single listing by slug
   - Must be: status = 'approved' AND is_active = true (for public)
   - Include ALL related data in ONE response:
     {
       listing: {
         ...all listing fields,
         category: { id, name, slug, icon },
         subcategory: { id, name, slug } | null,
         barangay: { id, name, slug },
         city: { id, name, slug },
         owner: { id, full_name } | null (minimal, no email for public),
         images: [{ id, image_url, alt_text, sort_order, is_primary }],
         dynamic_fields: [
           {
             field: { id, field_name, field_label, field_type, options },
             value: any (parsed from JSONB)
           }
         ],
         active_deals: [{ id, title, description, image_url, discount_text, start_date, end_date }],
         upcoming_events: [{ id, title, slug, description, image_url, event_date, start_time, end_time, venue }],
         current_plan: "free" | "featured" | "premium",
         is_claimed: boolean (owner_id is not null),
         has_owner: boolean
       }
     }
   - Return 404 if listing not found, not approved, or not active
   - Cache: revalidate every 5 minutes
   - Track page view: increment a view counter (create a simple page_views tracking)

2. /app/api/listings/[slug]/related/route.ts:
   - GET: Fetch related listings
   - Same subcategory first, then same category, same city
   - Exclude the current listing
   - Limit: 4
   - Return lightweight listing data (for cards)

3. /app/api/listings/[slug]/contact-click/route.ts:
   - POST: Track contact interactions
   - Body: { type: "phone" | "email" | "website" | "directions" | "facebook" | "instagram" | "tiktok" }
   - Store in a listing_analytics table
   - Used for business owner dashboard analytics

4. CREATE listing_analytics table (provide SQL):
   - id (UUID)
   - listing_id (FK)
   - event_type (VARCHAR: page_view, phone_click, email_click, website_click, directions_click, social_click, share)
   - event_data (JSONB, nullable — e.g., { platform: "facebook" })
   - visitor_id (VARCHAR, nullable — anonymous session ID from cookie)
   - created_at (timestamp, default now)
   - INDEX on listing_id, event_type, created_at
   - RLS: anyone can INSERT (for tracking), business owner + admin can SELECT for their listings

5. UPDATE /lib/types.ts:
   - Add ListingDetail type (full listing with all relations)
   - Add ListingAnalyticsEvent type
   - Add DynamicFieldWithValue type

6. CREATE /lib/analytics.ts:
   - trackPageView(listingId, visitorId)
   - trackContactClick(listingId, eventType, eventData, visitorId)
   - getVisitorId() — generates/retrieves anonymous visitor ID from cookie

Output all files with complete code including the SQL for the new analytics table.