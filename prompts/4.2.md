Continuing the GalaPo project. Build backend API routes for category pages and filtered listings.

TECH: Next.js 16 Route Handlers, Supabase, TypeScript
EXISTING: /app/api/categories/route.ts already returns categories with counts.

REQUIREMENTS:

1. /app/api/categories/[slug]/route.ts:
   - GET: Fetch single category by slug
   - Include: subcategories with listing counts, category_fields (dynamic fields)
   - If slug is a parent category, include all subcategories
   - If slug is a subcategory, include parent info
   - Return 404 if not found or inactive
   - Cache: revalidate every 15 minutes

2. /app/api/listings/route.ts (MAIN LISTINGS ENDPOINT):
   - GET: Fetch listings with comprehensive filtering
   - Query parameters:
     - city (string, default "olongapo")
     - category (string, parent category slug)
     - subcategory (string, subcategory slug)
     - barangay (string or comma-separated string for multi-select, barangay slugs)
     - q (string, search keyword — matches business_name, tags, short_description)
     - featured_only (boolean)
     - open_now (boolean — compare operating_hours JSON with current PH time)
     - sort (string: "featured" | "newest" | "name_asc" | "name_desc")
     - page (number, default 1)
     - limit (number, default 20, max 50)
   
   - SORTING LOGIC (critical for monetization):
     1. FIRST: top_search_placements for this category (ordered by position 1,2,3) — only if searching within a category
     2. THEN: is_premium = true (ordered by updated_at DESC)
     3. THEN: is_featured = true (ordered by updated_at DESC)
     4. THEN: regular listings sorted by the user's chosen sort
   
   - Response shape:
     {
       data: Listing[],
       pagination: {
         page: number,
         limit: number,
         total: number,
         total_pages: number,
         has_next: boolean,
         has_previous: boolean
       },
       sponsored: Listing[], // top_search_placements (separate for UI to render differently)
       filters_applied: {
         category: string | null,
         subcategory: string | null,
         barangay: string[] | null,
         search: string | null,
         featured_only: boolean,
         open_now: boolean,
         sort: string
       }
     }
   
   - Include with each listing:
     - primary_image (first image from listing_images)
     - category_name, subcategory_name
     - barangay_name
     - active_deals_count
     - current_plan (from active subscription)
   
   - Only return: status = 'approved' AND is_active = true
   - Cache: NO cache (dynamic filtered results)

3. /app/api/listings/map/route.ts:
   - GET: Fetch listings for map view (lightweight, just coordinates + basic info)
   - Same filters as /api/listings but returns minimal data:
     {
       id, business_name, slug, lat, lng, 
       category_name, subcategory_name, 
       is_featured, is_premium,
       primary_image_url
     }
   - No pagination (return all matching, max 500)
   - This prevents loading full listing data for map pins

4. /app/api/top-search/[category]/route.ts:
   - GET: Fetch active top search placements for a category
   - Only return where: start_date <= today AND end_date >= today AND is_active = true
   - Join with listings table for full listing data
   - Order by position ASC (1, 2, 3)
   - Include listing details same as /api/listings

5. UPDATE /lib/queries.ts:
   - Add buildListingsQuery(filters) function:
     - Accepts all filter params
     - Builds Supabase query dynamically
     - Handles the complex sort order (sponsored > premium > featured > regular)
     - Handles "open now" logic by comparing JSONB operating_hours with current PH time
     - Handles barangay multi-select
     - Handles text search across multiple columns using pg_trgm
   
   - Add getOpenNowFilter() function:
     - Gets current day of week in Philippines timezone (Asia/Manila)
     - Gets current time in PH
     - Returns filter condition for operating_hours JSONB
     - Example: If it's Monday 14:00 PH time, filter where operating_hours->monday->is_closed = false AND operating_hours->monday->open <= '14:00' AND operating_hours->monday->close >= '14:00'

6. CREATE /lib/search-helpers.ts:
   - parseSearchParams(searchParams): validated and typed filter object
   - buildFilterUrl(baseUrl, filters): generates URL with query params
   - getActiveDay(): returns current day name in PH timezone
   - isOpenNow(operatingHours): checks if business is currently open

Output all files with complete code. Ensure the sorting logic correctly prioritizes paid placements.