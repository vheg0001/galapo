Continuing the GalaPo project. Build/enhance the backend search API.

TECH: Next.js 16 Route Handlers, Supabase PostgreSQL, TypeScript
EXISTING: /app/api/listings/route.ts handles filtered listings.

REQUIREMENTS:

1. ENHANCE /app/api/listings/route.ts:
   - Add full-text search capability:
     - Query param: q (search query string)
     - Search across: business_name, short_description, full_description, tags
     - Use PostgreSQL pg_trgm for fuzzy matching (handles typos)
     - Rank results by relevance when q is provided:
       - Exact match on business_name → highest rank
       - Partial match on business_name → high rank
       - Match in tags → medium rank
       - Match in description → lower rank
     - Use ts_rank or similarity() function from pg_trgm
   
   - Add distance-based filtering:
     - Query params: lat, lng, radius (in km, default 10)
     - If lat/lng provided, calculate distance for each listing
     - Include distance_km in response
     - Support sort=distance when lat/lng provided
     - Use PostgreSQL earth_distance extension or manual Haversine in SQL:
       (6371 * acos(cos(radians(lat)) * cos(radians(listing.lat)) * cos(radians(listing.lng) - radians(lng)) + sin(radians(lat)) * sin(radians(listing.lat))))
   
   - "Open Now" filter enhancement:
     - Accept timezone: Asia/Manila
     - Get current PH day and time
     - Filter listings where:
       operating_hours->>current_day->>'is_closed' = false
       AND operating_hours->>current_day->>'open' <= current_time
       AND operating_hours->>current_day->>'close' >= current_time
     - Handle edge cases: midnight crossover, 24-hour businesses, null hours

2. CREATE Supabase Database Function for search (SQL to run in editor):

   CREATE OR REPLACE FUNCTION search_listings(
     search_query TEXT DEFAULT NULL,
     category_slug TEXT DEFAULT NULL,
     subcategory_slug TEXT DEFAULT NULL,
     barangay_slugs TEXT[] DEFAULT NULL,
     city_slug TEXT DEFAULT 'olongapo',
     is_open_now BOOLEAN DEFAULT FALSE,
     featured_only BOOLEAN DEFAULT FALSE,
     user_lat DOUBLE PRECISION DEFAULT NULL,
     user_lng DOUBLE PRECISION DEFAULT NULL,
     radius_km DOUBLE PRECISION DEFAULT 10,
     sort_by TEXT DEFAULT 'featured',
     page_number INTEGER DEFAULT 1,
     page_size INTEGER DEFAULT 20
   )
   RETURNS JSON
   
   This function should:
   - Handle all filtering logic server-side for performance
   - Return paginated results with total count
   - Include sponsored placements at top
   - Calculate distance if lat/lng provided
   - Rank by relevance if search_query provided
   - Return the complete response shape matching the /api/listings endpoint

3. /app/api/search/suggestions/route.ts (for future use):
   - GET: Return search suggestions based on partial query
   - Query param: q (minimum 2 characters)
   - Return top 5 matching:
     - Business names
     - Category names
     - Subcategory names
   - Response: { businesses: [], categories: [], subcategories: [] }
   - Use pg_trgm similarity for fuzzy matching
   - Cache: 5 minutes
   - (This is for future autocomplete, build the endpoint now)

4. /app/api/listings/search-area/route.ts:
   - GET: Search within map bounds
   - Query params: north, south, east, west (map viewport bounds)
   - Returns listings within those geographic bounds
   - Lightweight response (for map pins only):
     { id, business_name, slug, lat, lng, category_name, is_featured, is_premium }
   - Used when user pans/zooms the map and clicks "Search this area"

5. UPDATE /lib/queries.ts:
   - Add searchListings() function that calls the Supabase RPC function
   - Add getListingsInBounds(north, south, east, west)
   - Add searchSuggestions(query)

6. CREATE /lib/geo.ts:
   - calculateDistance(lat1, lng1, lat2, lng2): number (km)
   - isWithinRadius(lat1, lng1, lat2, lng2, radiusKm): boolean
   - getBoundsFromCenter(lat, lng, radiusKm): { north, south, east, west }
   - OLONGAPO_CENTER = { lat: 14.8292, lng: 120.2834 }
   - OLONGAPO_DEFAULT_ZOOM = 13

Output all files with complete code including the SQL function.